---
import ScrollReveal from '../effects/ScrollReveal.astro';
import SectionHeading from '../ui/SectionHeading.astro';
import SkillBadge from '../ui/SkillBadge.astro';
import { skills, categoryLabels } from '../../data/skills';

const categories = Object.keys(categoryLabels);
---

<section class="section" id="skills">
  <div class="container">
    <ScrollReveal>
      <SectionHeading title="Tech Stack" subtitle="Technologies and tools I work with" />
    </ScrollReveal>

    <ScrollReveal delay={100}>
      <div class="filter-tabs">
        {categories.map((cat) => (
          <button
            class:list={['tab', { active: cat === 'all' }]}
            data-filter={cat}
          >
            {categoryLabels[cat]}
          </button>
        ))}
      </div>
    </ScrollReveal>

    <ScrollReveal delay={200}>
      <div class="skills-grid">
        {skills.map((skill, i) => (
          <SkillBadge name={skill.name} category={skill.category} index={i} />
        ))}
      </div>
    </ScrollReveal>
  </div>
</section>

<style>
  .filter-tabs {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-bottom: var(--space-10);
    flex-wrap: wrap;
  }

  .tab {
    padding: var(--space-2) var(--space-5);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    background: transparent;
    border: 1px solid var(--color-border);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .tab:hover {
    border-color: var(--color-primary-200);
    color: var(--color-primary-600);
  }

  .tab.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
  }

  .skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: var(--space-4);
    max-width: 900px;
    margin: 0 auto;
  }

  @media (max-width: 480px) {
    .skills-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script>
  function initSkills() {
    const tabs = document.querySelectorAll('.tab[data-filter]');
    const badges = document.querySelectorAll('.skill-badge') as NodeListOf<HTMLElement>;
    const grid = document.querySelector('.skills-grid');

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      badges.forEach((b) => b.classList.add('popped-in'));
    } else {
      if (grid) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (!entry.isIntersecting) return;
            observer.unobserve(entry.target);

            badges.forEach((badge, i) => {
              setTimeout(() => {
                badge.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                badge.classList.add('popped-in');
              }, i * 30);
            });
          });
        }, { threshold: 0.1 });

        observer.observe(grid);
      }
    }

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        tabs.forEach((t) => t.classList.remove('active'));
        tab.classList.add('active');

        const filter = (tab as HTMLElement).dataset.filter;
        badges.forEach((el, i) => {
          const match = filter === 'all' || el.dataset.category === filter;
          if (match) {
            el.style.display = '';
            el.classList.remove('popped-in');
            setTimeout(() => {
              el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              el.classList.add('popped-in');
            }, i * 20);
          } else {
            el.style.display = 'none';
          }
        });
      });
    });
  }

  initSkills();
  document.addEventListener('astro:page-load', initSkills);
</script>
